name: Agent Blame

on:
  pull_request:
    types: [closed]

jobs:
  agent-blame-post-merge:
    name: Agent Blame - Post Merge Attribution
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Agent Blame - Fetch attribution data
        run: |
          git fetch origin refs/notes/agentblame:refs/notes/agentblame 2>/dev/null || echo "No existing attribution notes"
          git fetch origin refs/notes/agentblame-analytics:refs/notes/agentblame-analytics 2>/dev/null || echo "No existing analytics notes"
          git fetch origin --tags 2>/dev/null || echo "No tags to fetch"
          git fetch origin refs/pull/${{ github.event.pull_request.number }}/head:refs/pull/${{ github.event.pull_request.number }}/head 2>/dev/null || echo "Could not fetch PR head"

      - name: Agent Blame - Transfer attribution to merge commit
        run: bunx @mesadev/agentblame@latest post-merge
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          MERGED_AT: ${{ github.event.pull_request.merged_at }}

      - name: Agent Blame - Push attribution notes
        run: |
          git push origin refs/notes/agentblame 2>/dev/null || echo "No attribution notes to push"
          git push origin refs/notes/agentblame-analytics 2>/dev/null || echo "No analytics notes to push"
          git push origin agentblame-analytics-anchor 2>/dev/null || echo "No analytics tag to push"
